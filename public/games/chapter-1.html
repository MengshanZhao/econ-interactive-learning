<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Shareholder Tax Challenge</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Arial', sans-serif; background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 50%, #16213e 100%); min-height: 100vh; display: flex; justify-content: center; align-items: center; color: white; overflow-x: hidden; position: relative; }
    body::before { content: ""; position: fixed; inset: 0; background: url('/images/financial_manager.gif') center/cover no-repeat; opacity: 0.08; mix-blend-mode: screen; pointer-events: none; z-index: 0; }
    .profit-background { position: fixed; inset: 0; z-index: 1; opacity: 0.15; transition: all 1s ease; }
    .profit-line { position: absolute; width: 100%; height: 4px; background: linear-gradient(90deg, transparent, #4ecdc4, transparent); animation: moveProfitLine 4s infinite linear; }
    .profit-line.loss { background: linear-gradient(90deg, transparent, #ff4757, transparent); animation: moveLossLine 2s infinite linear; }
    @keyframes moveProfitLine { 0% { transform: translateX(-100%) translateY(0); } 100% { transform: translateX(100%) translateY(-20px); } }
    @keyframes moveLossLine { 0% { transform: translateX(-100%) translateY(0); } 100% { transform: translateX(100%) translateY(20px); } }
    .balance-meter { width: 100%; max-width: 300px; margin: 0 auto 20px auto; background: rgba(0,0,0,0.7); padding: 15px; border-radius: 10px; border: 2px solid #4ecdc4; }
    @media (max-width: 768px) {
      .balance-meter { max-width: 250px; padding: 12px; }
      .balance-label { font-size: 13px; }
      .balance-text { font-size: 11px; }
    }
    .balance-label { font-size: 14px; margin-bottom: 8px; text-align: center; }
    .balance-bar { width: 100%; height: 20px; background: #333; border-radius: 10px; overflow: hidden; position: relative; }
    .balance-fill { height: 100%; background: linear-gradient(90deg, #ff4757 0%, #ffc048 50%, #4ecdc4 100%); transition: width 1s ease, background 0.5s ease; border-radius: 10px; }
    .balance-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 12px; font-weight: bold; color: white; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); }
    
    .container { background: rgba(0,0,0,0.7); backdrop-filter: blur(20px); border-radius: 25px; padding: 40px; max-width: 900px; width: 92%; text-align: center; box-shadow: 0 20px 60px rgba(0,0,0,0.5); z-index: 10; position: relative; border: 2px solid rgba(78,205,196,0.3); }
    .timer { font-size: 4em; font-weight: bold; margin-bottom: 20px; text-shadow: 3px 3px 6px rgba(0,0,0,0.7); transition: all 0.3s ease; }
    .timer.warning { color: #ffa726; animation: timerPulse 0.5s infinite; }
    .timer.danger { color: #ff5252; animation: timerShake 0.3s infinite; text-shadow: 0 0 20px #ff5252; }
    @keyframes timerPulse { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.15); } }
    @keyframes timerShake { 0%, 100% { transform: translateX(0) scale(1.05); } 25% { transform: translateX(-5px) scale(1.05); } 75% { transform: translateX(5px) scale(1.05); } }
    
    .scenario-box { background: rgba(78,205,196,0.1); border: 2px solid #4ecdc4; border-radius: 15px; padding: 20px; margin: 20px 0; font-size: 1.2em; line-height: 1.6; }
    .formula-box { background: rgba(255,193,7,0.1); border: 2px solid #ffc107; border-radius: 15px; padding: 18px; margin: 18px 0; font-family: 'Courier New', monospace; font-size: 1.05em; }
    .question { font-size: 1.6em; margin-bottom: 30px; line-height: 1.6; background: rgba(255,255,255,0.1); padding: 24px; border-radius: 18px; border-left: 6px solid #4ecdc4; animation: slideIn 0.7s ease; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
    
    .answers { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 28px; }
    .answer-btn { padding: 22px 18px; font-size: 1.2em; border: none; border-radius: 14px; background: rgba(255,255,255,0.1); color: white; cursor: pointer; transition: all 0.4s ease; border: 3px solid transparent; position: relative; overflow: hidden; }
    .answer-btn::before { content: ''; position: absolute; top: 0; left: -100%; width: 100%; height: 100%; background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent); transition: left 0.6s ease; }
    .answer-btn:hover { background: rgba(255,255,255,0.2); transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.4); }
    .answer-btn:hover::before { left: 100%; }
    .answer-btn.correct { background: linear-gradient(135deg, #4ecdc4, #26d0ce); border-color: #26d0ce; animation: correctShine 0.8s ease; }
    .answer-btn.incorrect { background: linear-gradient(135deg, #ff4757, #ff3742); border-color: #ff3742; animation: incorrectPulse 0.8s ease; }
    @keyframes correctShine { 0% { transform: scale(1) rotateY(0deg); } 50% { transform: scale(1.05) rotateY(180deg); box-shadow: 0 0 30px #4ecdc4; } 100% { transform: scale(1) rotateY(360deg); } }
    @keyframes incorrectPulse { 0%, 100% { transform: scale(1); } 25% { transform: scale(0.95) translateX(-3px); } 75% { transform: scale(0.95) translateX(3px); } }
    
    .start-btn, .ready-btn { padding: 18px 32px; font-size: 1.2em; background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%); color: white; border: none; border-radius: 14px; cursor: pointer; transition: all 0.4s ease; box-shadow: 0 8px 20px rgba(0,0,0,0.3); text-transform: uppercase; font-weight: bold; }
    .start-btn:hover, .ready-btn:hover { transform: translateY(-5px); box-shadow: 0 15px 35px rgba(0,0,0,0.4); background: linear-gradient(135deg, #26d0ce 0%, #369870 100%); }
    
    .score { font-size: 1.4em; margin: 18px 0; background: rgba(0,0,0,0.5); padding: 12px 16px; border-radius: 18px; display: inline-block; border: 2px solid #4ecdc4; }
    .hidden { display: none; }
    .sound-toggle { position: fixed; top: 20px; right: 20px; background: rgba(0,0,0,0.7); border: 2px solid #4ecdc4; color: white; padding: 10px; border-radius: 50%; cursor: pointer; font-size: 20px; z-index: 1001; transition: all 0.3s ease; }
    .sound-toggle:hover { background: rgba(78, 205, 196, 0.2); transform: scale(1.1); }
    
    .dramatic-flash { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; opacity: 0; }
    .dramatic-flash.success { background: radial-gradient(circle, rgba(78, 205, 196, 0.3) 0%, transparent 70%); animation: successFlash 0.5s ease; }
    .dramatic-flash.failure { background: radial-gradient(circle, rgba(255, 71, 87, 0.3) 0%, transparent 70%); animation: failureFlash 0.5s ease; }
    @keyframes successFlash { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }
    @keyframes failureFlash { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }
    
    .countdown-timer { font-size: 8em; font-weight: bold; color: #ff4757; text-shadow: 0 0 20px #ff4757; animation: countdownPulse 1s ease-in-out; }
    @keyframes countdownPulse { 0% { transform: scale(0.5); opacity: 0; } 50% { transform: scale(1.2); opacity: 1; } 100% { transform: scale(1); opacity: 1; } }
  </style>
</head>
<body>
  <div class="profit-background" id="profit-background"></div>
  <button class="sound-toggle" id="sound-toggle" onclick="toggleSound()">üîä</button>
  
  <!-- Dramatic Flash Effect -->
  <div class="dramatic-flash" id="dramatic-flash"></div>
  
  <div class="container">
    <!-- Soul Balance Meter -->
    <div class="balance-meter">
      <div class="balance-label">Soul Balance üëª</div>
      <div class="balance-bar">
        <div class="balance-fill" id="balance-fill" style="width: 100%"></div>
        <div class="balance-text" id="balance-text">100%</div>
      </div>
    </div>
    
    <div id="welcome-screen">
      <h1>üëª Haunted Finance Challenge</h1>
      <p style="margin: 20px 0; font-size: 1.2em;">The ghostly CFO is watching your every calculation... üòà</p>
      <button class="start-btn" onclick="startPractice()">Enter the Cursed Office üè¢</button>
    </div>
    <div id="practice-screen" class="hidden">
      <h2>üîÆ Learn the Dark Arts of Finance</h2>
      <div class="scenario-box">
        <strong>Cursed Scenario:</strong> Earnings <span style="color:#4ecdc4;">$12.00</span>, Corporate tax <span style="color:#ffc107;">25%</span>, Personal tax <span style="color:#ff6b6b;">30%</span>
      </div>
      <div class="formula-box">
        <strong>After Corporate Tax:</strong> Earnings √ó (1 ‚àí Corporate Tax Rate) ‚Üí $9.00<br />
        <strong>Your Personal Tax:</strong> After‚ÄëCorporate‚ÄëTax √ó Personal Tax Rate ‚Üí $2.70<br />
        <strong>Your Final Revenue:</strong> $9.00 ‚àí $2.70 = $6.30<br />
        <strong>Total Taxes Paid:</strong> $3.00 + $2.70 = $5.70
      </div>
      <div class="question"><strong>Trial Question:</strong> What is your final revenue per share?</div>
      <div class="answers" id="practice-answers">
        <button class="answer-btn" onclick="handlePracticeAnswer(0)">$5.40</button>
        <button class="answer-btn" onclick="handlePracticeAnswer(1)">$6.30</button>
        <button class="answer-btn" onclick="handlePracticeAnswer(2)">$7.20</button>
        <button class="answer-btn" onclick="handlePracticeAnswer(3)">$8.10</button>
      </div>
      <button class="ready-btn hidden" id="ready-btn" onclick="getReady()">Face the Haunted Challenge! üëª</button>
    </div>
    <div id="countdown-screen" class="hidden">
      <h2>The ghostly CFO is preparing your doom... üëª</h2>
      <div class="countdown-timer" id="countdown-display">3</div>
    </div>
    <div id="game-screen" class="hidden">
      <div class="timer" id="timer">40</div>
      <div class="score">Cursed Question <span id="current-q">1</span> of <span id="total-q">5</span></div>
      <div class="scenario-box" id="scenario-box"></div>
      <div class="question" id="question"></div>
      <div class="answers" id="answers"></div>
    </div>
    <div id="results-screen" class="hidden">
      <h2>ü¶á The Haunted Session Ends... ü¶á</h2>
      <div style="font-size: 2.5em; margin: 30px 0; color: #4ecdc4;" id="final-score"></div>
      <div style="font-size: 1.3em; margin: 20px 0;" id="performance-message"></div>
      <button class="start-btn" onclick="resetGame()">Dare to Face Her Again? üòà</button>
    </div>
  </div>
  
  <script>
    let currentQuestionIndex = 0;
    let correctAnswers = 0;
    let totalQuestions = 5;
    let timer;
    let timeLeft = 40;
    let soundEnabled = true;
    let audioContext;
    let balancePercentage = 100;
    let currentScenario = {};
    let gameQuestions = [];
    
    function generateRandomScenario() {
        const earnings = (Math.random() * 15 + 5).toFixed(2); // $5-20
        const corporateTax = Math.floor(Math.random() * 20 + 15); // 15-35%
        const personalTax = Math.floor(Math.random() * 25 + 20); // 20-45%
        
        const afterCorporateTax = earnings * (1 - corporateTax / 100);
        const personalTaxAmount = afterCorporateTax * (personalTax / 100);
        const finalRevenue = afterCorporateTax - personalTaxAmount;
        const totalTaxes = (earnings * corporateTax / 100) + personalTaxAmount;
        
        return {
            earnings: parseFloat(earnings),
            corporateTax,
            personalTax,
            afterCorporateTax: parseFloat(afterCorporateTax.toFixed(2)),
            personalTaxAmount: parseFloat(personalTaxAmount.toFixed(2)),
            finalRevenue: parseFloat(finalRevenue.toFixed(2)),
            totalTaxes: parseFloat(totalTaxes.toFixed(2))
        };
    }
    
    function generateQuestion(scenario) {
        const questionType = Math.random() > 0.5 ? 'revenue' : 'taxes';
        
        if (questionType === 'revenue') {
            const correctAnswer = scenario.finalRevenue;
            const wrongAnswers = [
                (correctAnswer * 0.8).toFixed(2),
                (correctAnswer * 1.2).toFixed(2),
                (correctAnswer * 0.9).toFixed(2)
            ].map(x => parseFloat(x));
            
            return {
                type: 'revenue',
                question: 'What is your final revenue per share after all taxes?',
                correct: correctAnswer,
                answers: shuffleArray([correctAnswer, ...wrongAnswers]).map(x => `$${x.toFixed(2)}`)
            };
        } else {
            const correctAnswer = scenario.totalTaxes;
            const wrongAnswers = [
                (correctAnswer * 0.7).toFixed(2),
                (correctAnswer * 1.3).toFixed(2),
                (correctAnswer * 0.85).toFixed(2)
            ].map(x => parseFloat(x));
            
            return {
                type: 'taxes',
                question: 'What is the total amount of taxes paid per share?',
                correct: correctAnswer,
                answers: shuffleArray([correctAnswer, ...wrongAnswers]).map(x => `$${x.toFixed(2)}`)
            };
        }
    }
    
    function shuffleArray(array) {
        const newArray = [...array];
        for (let i = newArray.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
        }
        return newArray;
    }
    
    function initAudio() {
        if (!audioContext) {
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
    }
    
    function playSound(frequency, duration, type = 'sine', volume = 0.1) {
        if (!soundEnabled) return;
        
        initAudio();
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        
        oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
        oscillator.type = type;
        
        gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
        
        oscillator.start(audioContext.currentTime);
        oscillator.stop(audioContext.currentTime + duration);
    }
    
    function playScarySound(isCorrect) {
        if (!soundEnabled) return;
        
        if (isCorrect) {
            // Eerie success sound
            playSound(440, 0.3, 'triangle', 0.12);
            setTimeout(() => playSound(660, 0.2, 'sine', 0.08), 150);
        } else {
            // Ominous failure sound
            playSound(150, 0.8, 'sawtooth', 0.15);
            setTimeout(() => playSound(100, 0.4, 'square', 0.1), 200);
        }
    }
    
    function addProfitLine(isProfit = true) {
        const line = document.createElement('div');
        line.className = `profit-line ${isProfit ? '' : 'loss'}`;
        line.style.top = Math.random() * 80 + 10 + '%';
        line.style.animationDelay = Math.random() * 2 + 's';
        
        document.getElementById('profit-background').appendChild(line);
        
        setTimeout(() => {
            if (line.parentNode) {
                line.remove();
            }
        }, 4000);
    }
    
    function updateBalance(isCorrect) {
        if (isCorrect) {
            balancePercentage = Math.min(100, balancePercentage + 5);
        } else {
            balancePercentage = Math.max(0, balancePercentage - 20);
        }
        
        const balanceFill = document.getElementById('balance-fill');
        const balanceText = document.getElementById('balance-text');
        
        balanceFill.style.width = balancePercentage + '%';
        balanceText.textContent = Math.round(balancePercentage) + '%';
        
        // Change color based on balance
        if (balancePercentage > 70) {
            balanceFill.style.background = 'linear-gradient(90deg, #4ecdc4 0%, #26d0ce 100%)';
        } else if (balancePercentage > 30) {
            balanceFill.style.background = 'linear-gradient(90deg, #ffc048 0%, #ffb347 100%)';
        } else {
            balanceFill.style.background = 'linear-gradient(90deg, #ff4757 0%, #ff3742 100%)';
        }
    }
    
    function updateCFOStatus(isCorrect) {
        const dramaticFlash = document.getElementById('dramatic-flash');
        
        if (isCorrect) {
            dramaticFlash.className = 'dramatic-flash success';
            addProfitLine(true);
            playScarySound(true);
        } else {
            dramaticFlash.className = 'dramatic-flash failure';
            addProfitLine(false);
            playScarySound(false);
        }
        
        setTimeout(() => {
            dramaticFlash.className = 'dramatic-flash';
        }, 1500);
    }
    
    function toggleSound() {
        soundEnabled = !soundEnabled;
        document.getElementById('sound-toggle').textContent = soundEnabled ? 'üîä' : 'üîá';
    }
    
    function startPractice() {
        document.getElementById('welcome-screen').classList.add('hidden');
        document.getElementById('practice-screen').classList.remove('hidden');
    }
    
    function handlePracticeAnswer(selected) {
        const buttons = document.querySelectorAll('#practice-answers .answer-btn');
        const correctIndex = 1; // $6.30 is correct
        
        buttons.forEach((btn, index) => {
            btn.disabled = true;
            if (index === correctIndex) {
                btn.classList.add('correct');
            } else if (index === selected && selected !== correctIndex) {
                btn.classList.add('incorrect');
            }
        });
        
        updateCFOStatus(selected === correctIndex);
        updateBalance(selected === correctIndex);
        
        setTimeout(() => {
            document.getElementById('ready-btn').classList.remove('hidden');
        }, 1500);
    }
    
    function getReady() {
        document.getElementById('practice-screen').classList.add('hidden');
        document.getElementById('countdown-screen').classList.remove('hidden');
        
        let count = 3;
        const countdownDisplay = document.getElementById('countdown-display');
        
        const countdownInterval = setInterval(() => {
            countdownDisplay.textContent = count;
            playSound(800, 0.2, 'square', 0.2);
            count--;
            
            if (count < 0) {
                clearInterval(countdownInterval);
                startGame();
            }
        }, 1000);
    }
    
    function startGame() {
        document.getElementById('countdown-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
        
        // Generate questions
        gameQuestions = [];
        for (let i = 0; i < totalQuestions; i++) {
            const scenario = generateRandomScenario();
            const question = generateQuestion(scenario);
            gameQuestions.push({ scenario, question });
        }
        
        currentQuestionIndex = 0;
        correctAnswers = 0;
        balancePercentage = 100;
        
        // Start continuous background lines
        setInterval(() => addProfitLine(Math.random() > 0.3), 1500);
        
        loadQuestion();
        startTimer();
    }
    
    function loadQuestion() {
        if (currentQuestionIndex >= gameQuestions.length) {
            endGame();
            return;
        }
        
        const { scenario, question } = gameQuestions[currentQuestionIndex];
        
        document.getElementById('current-q').textContent = currentQuestionIndex + 1;
        document.getElementById('total-q').textContent = totalQuestions;
        
        // Update scenario box
        document.getElementById('scenario-box').innerHTML = `
            <strong>The CFO's Cursed Scenario:</strong><br>
            Per share earnings (before the tax demons): <span style="color: #4ecdc4;">$${scenario.earnings.toFixed(2)}</span><br>
            Corporate tax curse: <span style="color: #ffc107;">${scenario.corporateTax}%</span><br>
            Your personal tax burden: <span style="color: #ff6b6b;">${scenario.personalTax}%</span>
        `;
        
        document.getElementById('question').textContent = question.question;
        
        const answersDiv = document.getElementById('answers');
        answersDiv.innerHTML = '';
        
        const correctAnswer = `$${question.correct.toFixed(2)}`;
        
        question.answers.forEach((answer, index) => {
            const btn = document.createElement('button');
            btn.className = 'answer-btn';
            btn.textContent = answer;
            btn.onclick = () => handleAnswer(answer === correctAnswer);
            answersDiv.appendChild(btn);
        });
        
        timeLeft = 40;
        updateTimerDisplay();
    }
    
    function handleAnswer(isCorrect) {
        const buttons = document.querySelectorAll('#answers .answer-btn');
        buttons.forEach(btn => btn.disabled = true);
        
        if (isCorrect) {
            correctAnswers++;
            buttons.forEach(btn => {
                if (btn.textContent === `$${gameQuestions[currentQuestionIndex].question.correct.toFixed(2)}`) {
                    btn.classList.add('correct');
                }
            });
        } else {
            buttons.forEach(btn => {
                if (btn.textContent === `$${gameQuestions[currentQuestionIndex].question.correct.toFixed(2)}`) {
                    btn.classList.add('correct');
                } else if (btn === event.target) {
                    btn.classList.add('incorrect');
                }
            });
        }
        
        updateCFOStatus(isCorrect);
        updateBalance(isCorrect);
        clearInterval(timer);
        
        setTimeout(() => {
            currentQuestionIndex++;
            loadQuestion();
            if (currentQuestionIndex < gameQuestions.length) {
                startTimer();
            }
        }, 2000);
    }
    
    function startTimer() {
        timer = setInterval(() => {
            timeLeft--;
            updateTimerDisplay();
            
            if (timeLeft <= 5) {
                playSound(1000, 0.1, 'square', 0.05);
            }
            
            if (timeLeft <= 0) {
                clearInterval(timer);
                updateCFOStatus(false);
                updateBalance(false);
                
                const buttons = document.querySelectorAll('#answers .answer-btn');
                buttons.forEach(btn => btn.disabled = true);
                
                setTimeout(() => {
                    currentQuestionIndex++;
                    loadQuestion();
                    if (currentQuestionIndex < gameQuestions.length) {
                        startTimer();
                    }
                }, 1500);
            }
        }, 1000);
    }
    
    function updateTimerDisplay() {
        const timerEl = document.getElementById('timer');
        timerEl.textContent = timeLeft;
        
        timerEl.className = 'timer';
        if (timeLeft <= 3) {
            timerEl.classList.add('danger');
        } else if (timeLeft <= 7) {
            timerEl.classList.add('warning');
        }
    }
    
    function endGame() {
        clearInterval(timer);
        document.getElementById('game-screen').classList.add('hidden');
        document.getElementById('results-screen').classList.remove('hidden');
        
        const percentage = (correctAnswers / totalQuestions) * 100;
        const balanceGrade = balancePercentage > 70 ? 'Excellent' : balancePercentage > 40 ? 'Good' : 'Needs Improvement';
        
        document.getElementById('final-score').textContent = `${correctAnswers}/${totalQuestions} Correct (${percentage.toFixed(0)}%)`;
        
        let message = '';
        if (percentage >= 80 && balancePercentage > 60) {
            message = 'üëª EXCELLENT! The ghostly CFO is pleased... you have mastered her dark arts!';
        } else if (percentage >= 60) {
            message = 'ü¶á Good work! The haunted calculations are becoming clearer to you...';
        } else {
            message = 'üíÄ The CFO\'s curse grows stronger! Study the forbidden formulas and return!';
        }
        
        message += `<br><br>Your Soul\'s Balance: ${balanceGrade} (${balancePercentage.toFixed(0)}%)`;
        
        document.getElementById('performance-message').innerHTML = message;
    }
    
    function resetGame() {
        document.getElementById('results-screen').classList.add('hidden');
        document.getElementById('welcome-screen').classList.remove('hidden');
        currentQuestionIndex = 0;
        correctAnswers = 0;
        balancePercentage = 100;
        
        // Reset balance display
        updateBalance(true);
        
        // Clear background lines
        document.getElementById('profit-background').innerHTML = '';
    }
  </script>
</body>
</html>