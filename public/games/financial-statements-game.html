<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Financial Statements Analysis Game — Auto Slot Builder</title>
  <link href="https://fonts.googleapis.com/css2?family=Kalam:wght@300;400;700&family=Chalkduster&family=Creepster&display=swap" rel="stylesheet">
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Comic Sans MS','Chalkboard SE','Chalkboard',fantasy;
      background: linear-gradient(135deg,#f5f3f0 0%,#e8e5e0 100%);
      background-image:
        radial-gradient(circle at 20px 50px,#ddd 2px,transparent 2px),
        radial-gradient(circle at 40px 80px,#ddd 1px,transparent 1px);
      background-size:100px 100px;
      min-height:100vh; padding:20px; color:#2c3e50;
    }
    .container {
      max-width:1400px; margin:0 auto; background:#fff;
      background-image:
        linear-gradient(90deg,transparent 79px,#abced4 79px,#abced4 81px,transparent 81px),
        linear-gradient(#eee .1em,transparent .1em);
      background-size:100% 1.2em;
      border-radius:15px;
      box-shadow:0 20px 40px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.6);
      overflow:hidden; border:3px solid #d4b896;
    }
    .header {
      background: linear-gradient(135deg,#8b7355,#a0906b); color:#fff;
      padding:15px 25px; text-align:center; position:relative; border-bottom:3px solid #d4b896;
    }
    .header::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;
      background:repeating-linear-gradient(45deg,#d4b896,#d4b896 10px,#c4a575 10px,#c4a575 20px);
    }
    .header h1{font-size:2em;margin-bottom:5px;text-shadow:2px 2px 4px rgba(0,0,0,0.3);}
    .header p{opacity:.95;}
    .progress-bar{background:rgba(255,255,255,0.3);height:8px;border-radius:4px;margin:10px 0 0;overflow:hidden;border:1px solid rgba(255,255,255,0.5);}
    .progress-fill{background:linear-gradient(90deg,#4CAF50,#45a049);height:100%;width:0%;transition:width .8s ease;border-radius:3px;position:relative;}
    .progress-fill::after{content:'';position:absolute;top:0;left:0;right:0;bottom:0;
      background:linear-gradient(90deg,transparent,rgba(255,255,255,0.4),transparent);
      animation:shimmer 2s infinite;}
    @keyframes shimmer{0%{transform:translateX(-100%);}100%{transform:translateX(100%);}}
    .game-area{padding:30px; padding-left:100px;}
    .step{display:none;}
    .step.active{display:block; animation:slideIn .6s ease;}
    @keyframes slideIn{from{opacity:0;transform:translateX(30px);}to{opacity:1;transform:translateX(0);}}

    /* Step 1 */
    .question-container{text-align:center;max-width:800px;margin:0 auto;}
    .question-header{font-size:2.2em;color:#8b7355;margin-bottom:12px;font-weight:bold;}
    .howto{margin:0 auto 16px; max-width:800px; font-size:.95em; background:#fff8e1; border:1px solid #ffe08a; color:#6b4f00; padding:10px 12px; border-radius:10px;}
    .question-counter{background:#f8f9fa;border:2px dashed #8b7355;border-radius:10px;padding:8px 16px;display:inline-block;margin-bottom:18px;font-weight:600;}
    .financial-statement{background:#fdfdfd;border:3px solid #d4b896;border-radius:15px;padding:25px;margin:18px 0;font-family:'Courier New',monospace;font-size:15px;text-align:left;
      box-shadow:0 10px 25px rgba(0,0,0,0.1), inset 0 1px 0 rgba(255,255,255,0.8);
      transform:rotate(.3deg);transition:all .4s ease;}
    .financial-statement:hover{transform:rotate(0deg) scale(1.02); box-shadow:0 15px 35px rgba(0,0,0,0.15);}
    .statement-title{font-family:'Comic Sans MS','Chalkboard SE',fantasy;font-weight:bold;font-size:20px;margin-bottom:12px;color:#8b7355;border-bottom:2px solid #d4b896;padding-bottom:8px;text-align:center;}
    .choice-buttons{display:flex;gap:20px;justify-content:center;margin:14px 0;}
    .btn{background:linear-gradient(135deg,#8b7355,#a0906b); color:#fff; border:none; padding:12px 20px; border-radius:25px; cursor:pointer; font-family:'Comic Sans MS','Chalkboard SE',fantasy; font-size:16px; font-weight:600; transition:all .3s ease; min-width:160px; box-shadow:0 4px 15px rgba(139,115,85,0.3);}
    .btn:hover{background:linear-gradient(135deg,#a0906b,#8b7355); transform:translateY(-2px); box-shadow:0 8px 25px rgba(139,115,85,0.4);}
    .btn.correct{background:linear-gradient(135deg,#4CAF50,#45a049);}
    .btn.incorrect{background:linear-gradient(135deg,#e74c3c,#c0392b);}
    .feedback-message{font-weight:bold;margin:10px 0;padding:10px;border-radius:10px;}
    .feedback-message.correct{background:#e9f7ef;color:#155724;border:2px solid #c3e6cb;}
    .feedback-message.incorrect{background:#fdecea;color:#721c24;border:2px solid #f5c6cb;}
    .next-btn{background:linear-gradient(135deg,#17a2b8,#138496);color:#fff;border:none;padding:12px 25px;border-radius:25px;cursor:pointer;font-family:'Comic Sans MS','Chalkboard SE',fantasy;font-size:16px;font-weight:600;margin:18px auto;display:block;}

    /* Step 2 - Improved layout with ratios on the right */
    .main-game{display:flex;gap:20px;margin-top:12px;align-items:flex-start;min-height:520px;}
    .statement-panel{flex:0 0 70%;background:#fdfdfd;border:3px solid #d4b896;border-radius:15px;padding:16px;box-shadow:0 10px 25px rgba(0,0,0,0.1);overflow-y:auto;max-height:540px;scroll-behavior:smooth;}
    .ratios-panel{flex:0 0 28%;background:#f0f8ff;border:3px solid #4169e1;border-radius:15px;padding:12px;box-shadow:0 10px 25px rgba(0,0,0,0.1);max-height:540px;overflow-y:auto;}
    .ratios-panel h3{font-size:1.05em;color:#4169e1;text-align:center;margin-bottom:8px;font-weight:bold;border-bottom:2px solid #4169e1;padding-bottom:6px;}
    .section-divider{border-bottom:2px solid #d4b896;margin:8px 0 4px;padding-bottom:4px;font-weight:bold;color:#8b7355;font-size:14px;}
    .statement-line{display:flex;justify-content:space-between;padding:4px 8px;margin:1px 0;border-radius:5px;transition:all .2s ease;font-family:'Courier New',monospace;cursor:pointer;font-size:13px;line-height:1.3;}
    .statement-line:hover{background:#f0f0f0;}
    .ratio-category{margin-bottom:10px;border-radius:8px;overflow:hidden;border:2px solid #d4b896;box-shadow:0 2px 8px rgba(0,0,0,0.06);}
    .category-header{background:linear-gradient(135deg,#8b7355,#a0906b);color:#fff;padding:6px 8px;font-weight:bold;font-size:.9em;}
    .ratio-button{display:block;width:100%;background:#fff;border:1px solid #e9ecef;padding:6px 8px;margin:2px 0;border-radius:6px;cursor:pointer;transition:all .2s ease;text-align:left;font-family:'Comic Sans MS','Chalkboard SE',fantasy;font-weight:500;font-size:11px;line-height:1.2;}
    .ratio-button:hover{background:#f8f9fa;border-color:#8b7355;transform:translateX(2px);}
    .ratio-button.selected{background:linear-gradient(135deg,#8b7355,#a0906b);color:#fff;border-color:#8b7355;transform:translateX(3px);}
    .highlight{background:linear-gradient(135deg,#fff3cd,#ffeaa7)!important;border:2px solid #f39c12!important;}

    .switch-statement-btn{width:100%;margin-top:12px;background:linear-gradient(135deg,#17a2b8,#138496);font-size:14px;padding:10px;position:sticky;bottom:0;}

    /* Step 3 — improved right sidebar layout */
    .quiz-section{max-width:1300px;margin:0 auto;}
    .quiz-question{font-size:1.6em;font-weight:bold;margin-bottom:10px;color:#8b7355;text-align:center;}
    .howto-quiz{margin:0 auto 10px; max-width:1100px; font-size:.95em; background:#fff8e1; border:1px solid #ffe08a; color:#6b4f00; padding:10px 12px; border-radius:10px;}

    .quiz-grid{
      display:grid;
      grid-template-columns: 2fr 1fr;
      gap:16px;
      align-items:start;
    }
    .quiz-left{
      background:#fdfdfd;border:3px solid #d4b896;border-radius:15px;padding:14px;
      box-shadow:0 10px 25px rgba(0,0,0,0.06);
      max-height:600px; overflow:auto;
    }
    .dual-statements{display:grid; grid-template-columns:1fr 1fr; gap:12px;}
    .statement-card{border:2px solid #e5e7eb;border-radius:10px;padding:8px;background:#fff;}
    .statement-card .statement-title{margin:0 0 6px 0;}

    .quiz-right{
      display:grid;
      grid-template-rows: auto 1fr;
      gap:12px;
    }
    .ratio-ref{
      background:#eef6ff;border:2px solid #88b2ff;border-radius:12px; padding:10px;
      max-height:260px; overflow:auto;
    }
    .ratio-ref h4{color:#1b5fbf; text-align:center; margin-bottom:6px;}
    .ratio-ref .item{
      display:flex; justify-content:space-between; align-items:center;
      background:#fff; border:1px solid #d7e3ff; border-radius:8px; padding:6px 8px; margin:6px 0;
      font-size:.9em;
    }
    .ratio-ref .item .tpl{font-family:'Courier New',monospace; color:#0d47a1; font-weight:bold;}
    .ratio-ref .item.active{border-color:#1b5fbf; box-shadow:0 0 0 2px rgba(27,95,191,.12);}
    .ratio-ref .item small{opacity:.8;}

    .quiz-controls{
      background:#f8f9fa;border:3px solid #8b7355;border-radius:15px;padding:14px; max-height: 330px; overflow:auto;
    }
    .equation-display{background:#fff;border:2px solid #d4b896;border-radius:10px;padding:12px;margin:10px 0;}
    .slots-row{display:flex;flex-wrap:wrap; align-items:center; gap:8px; justify-content:center; font-weight:bold; color:#8b7355;}
    .op{font-size:1.5em; padding:0 4px;}
    .slot-pill{
      min-width:140px; min-height:36px; display:inline-flex; align-items:center; justify-content:center; gap:8px;
      background:linear-gradient(135deg,#e3f2fd,#bbdefb); border:2px solid #2196F3; color:#0d47a1;
      border-radius:24px; padding:6px 10px; cursor:pointer; position:relative;
    }
    .slot-pill.empty{opacity:.85; background:#f1f5f9; border:2px dashed #94a3b8; color:#475569;}
    .slot-pill.active{box-shadow:0 0 0 3px rgba(33,150,243,.25);}
    .slot-remove{
      background:#f44336; color:#fff; border:none; border-radius:50%; width:18px; height:18px; font-size:12px; cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center;
    }
    .selected-line{background:linear-gradient(135deg,#c8e6c9,#a5d6a7)!important;border-color:#4CAF50!important;color:#1b5e20;}
    .submit-quiz-btn{width:100%;margin-top:12px;background:linear-gradient(135deg,#28a745,#20c997);padding:12px;font-size:1.05em;}
    .clear-all-btn{background:#f44336;margin:6px 0;}

    .score-board{background:linear-gradient(135deg,#8b7355,#a0906b);color:#fff;padding:12px;border-radius:15px;text-align:center;margin:16px; font-size:1.1em;}

    /* Responsive */
    @media (max-width: 980px){
      .game-area{padding-left:30px;}
      .quiz-grid{grid-template-columns: 1fr;}
      .dual-statements{grid-template-columns:1fr;}
      .main-game{flex-direction:column;}
      .statement-panel{flex:none; width:100%;}
      .ratios-panel{flex:none; width:100%;}
    }

    /* simple modal */
    .modal-backdrop{position:fixed;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.45);z-index:999;}
    .modal{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);
      background:#fff;border-radius:16px; padding:24px; max-width:520px; width:92%;
      box-shadow:0 20px 40px rgba(0,0,0,.35); z-index:1000; text-align:center;}
    .modal.success{background:linear-gradient(135deg,#d4edda,#c3e6cb); border:3px solid #28a745; color:#155724;}
    .modal.error{background:linear-gradient(135deg,#f8d7da,#f1b0b7); border:3px solid #dc3545; color:#721c24;}
    .modal .title{font-size:1.5em;margin-bottom:6px;}
    .modal .btn{margin-top:10px;}
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>Financial Statement Analysis</h1>
    <p>Learn Balance Sheets and Income Statements</p>
    <div class="progress-bar"><div class="progress-fill" id="progressBar"></div></div>
  </div>

  <div class="game-area">
    <!-- Step 1: Statement Recognition -->
    <div class="step active" id="step1">
      <div class="question-container">
        <div class="question-header">Statement Recognition</div>
        <div class="howto"><strong>How this step works:</strong> Read the statement and choose whether it's a Balance Sheet or an Income Statement.</div>
        <div class="question-counter">Question <span id="currentQuestion">1</span> of 3</div>
        <div id="questionContent"></div>
      </div>
    </div>

    <!-- Step 2: Ratio Learning -->
    <div class="step" id="step2">
      <p class="howto" style="max-width:1100px;">
        <strong>Explore:</strong> Pick a ratio on the right to highlight the lines it uses in the current statement.
        Use "Switch" to toggle between Balance Sheet and Income Statement.
      </p>
      <div class="main-game">
        <div class="statement-panel">
          <div id="currentStatement"></div>
          <button class="btn switch-statement-btn" id="switchBtn">Switch</button>
        </div>
        <div class="ratios-panel">
          <h3>Financial Ratios</h3>
          <div id="ratioCategories"></div>
          <div style="margin-top:15px; padding:10px; background:#fff8e1; border:1px solid #ffe08a; border-radius:8px; font-size:0.9em; color:#6b4f00;">
            <strong>Ready for the quiz?</strong><br>
            Explore at least 3 different ratios to unlock the quiz challenge!
          </div>
          <button class="btn" id="startQuizBtn" style="display:none; margin-top:10px; position:sticky; bottom:10px;">Start Quiz Challenge</button>
        </div>
      </div>
    </div>

    <!-- Step 3: Quiz -->
    <div class="step" id="step3">
      <div class="quiz-section">
        <div class="quiz-question" id="quizQuestionText"></div>
        <p class="howto-quiz"><strong>Fill in the blanks:</strong> Simply click on items from the statements to fill the slots in order. The first item you click goes in the first slot, the second in the second slot, and so on. You can remove items by clicking the red "×" button. Submit when all slots are filled!</p>

        <div class="quiz-grid">
          <!-- Left: statements -->
          <div class="quiz-left">
            <div class="dual-statements" id="dualStatements"></div>
          </div>

          <!-- Right: ratio list + controls -->
          <div class="quiz-right">
            <div class="ratio-ref" id="ratioRef"></div>
            <div class="quiz-controls">
              <div class="equation-display">
                <div class="slots-row" id="slotsRow"></div>
              </div>
              <button class="btn clear-all-btn" id="clearAllBtn">✗ Clear All</button>
              <button class="btn submit-quiz-btn" id="submitQuizAnswer" disabled>Submit Answer</button>
            </div>
          </div>
        </div>
      </div>
      <div class="score-board">
        Quiz Score: <span id="quizScore">0</span> / <span id="totalQuestions">0</span>
      </div>
    </div>

    <!-- Final -->
    <div class="step" id="final">
      <div style="text-align:center;padding:40px;max-width:800px;margin:0 auto;">
        <h2 style="font-size:2.5em;color:#8b7355;margin-bottom:25px;font-weight:bold;">🎉 Congratulations!</h2>
        
        <div style="background:linear-gradient(135deg,#4CAF50,#45a049);color:white;padding:30px;border-radius:20px;margin:25px 0;font-size:1.3em;box-shadow:0 10px 30px rgba(76,175,80,0.3);">
          <h3 style="margin-bottom:15px;">Final Score: <span id="finalScore">0</span>%</h3>
          <p id="finalMessage" style="font-size:1.1em;"></p>
        </div>
        
        <div style="margin:30px 0; padding:25px; background:#f8f9fa; border-radius:15px; border:2px solid #d4b896; max-height:400px; overflow-y:auto;">
          <h3 style="color:#8b7355; margin-bottom:20px; font-size:1.4em;">📊 All Financial Ratios Covered:</h3>
          <div id="allRatiosDisplay" style="text-align:left;"></div>
        </div>
        
        <div style="margin-top:30px;">
          <p style="font-size:1.2em; color:#6c757d; margin-bottom:25px;">Would you like to take the quiz again?</p>
          <div style="display:flex; gap:20px; justify-content:center; flex-wrap:wrap;">
            <button class="btn" id="restartBtn" style="font-size:1.1em;padding:15px 30px; background:linear-gradient(135deg,#28a745,#20c997);">🔄 Yes, Take Quiz Again</button>
            <button class="btn" id="goHomeBtn" style="font-size:1.1em;padding:15px 30px; background:linear-gradient(135deg,#6c757d,#495057);">🏠 No, Go Back to Course</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ---------- Shared Data ----------
let currentStep = 1;
let step1Score = 0;
let step1QuestionIndex = 0;
let quizScore = 0;
let currentQuestionIndex = 0;
let selectedRatio = null;
let currentStatementType = 'balance';
let ratioInteractions = 0;

// Quiz slot state
let slotAssignments = {};   // e.g., {A:'Current Assets', B:'Current Liabilities'}
let activeSlotKey = null;
let currentQuestion = null;

const sampleBalanceSheet = {
  title: "TechCorp Balance Sheet (Dec 31, 2024)",
  data: {
    "Cash": 25000,
    "Cash & Short-term Investments": 28000,
    "Accounts Receivable": 18000,
    "Inventory": 12000,
    "Current Assets": 55000,
    "PP&E": 85000,
    "Total Assets": 140000,
    "Accounts Payable": 15000,
    "Short-term Debt": 8000,
    "Current Liabilities": 23000,
    "Long-term Debt": 45000,
    "Total Debt": 53000,
    "Total Liabilities": 68000,
    "Book Value of Equity": 72000,
    "Stockholders' Equity": 72000
  }
};

const sampleIncomeStatement = {
  title: "TechCorp Income Statement (Year Ended Dec 31, 2024)",
  data: {
    "Net Sales": 150000,
    "Sales": 150000,
    "Cost of Goods Sold": 90000,
    "Gross Profit": 60000,
    "Operating Expenses": 35000,
    "Operating Income": 25000,
    "EBIT": 25000,
    "Depreciation": 3000,
    "EBITDA": 28000,
    "Interest Expense": 3000,
    "Pretax Income": 22000,
    "Taxes": 5500,
    "Net Income": 16500,
    "Earnings per Share": 4.58,
    "Average Daily Sales": 411,
    "Average Daily Cost of Sales": 247
  }
};

// Step 1 questions
const recognitionQuestions = [
  {
    statement: `ACME Corp Financial Statement
Assets:
Cash                    $15,000
Accounts Receivable     $22,000
Inventory              $18,000
Total Current Assets   $55,000

Property & Equipment   $85,000
Total Assets          $140,000

Liabilities:
Accounts Payable       $12,000
Current Liabilities    $25,000
Long-term Debt         $40,000
Total Liabilities      $65,000

Stockholders' Equity   $75,000`,
    correct: "BALANCE SHEET",
    options: ["BALANCE SHEET","INCOME STATEMENT"]
  },
  {
    statement: `Global Inc Financial Statement
Net Sales              $200,000
Cost of Goods Sold     $120,000
Gross Profit           $80,000
Operating Expenses     $45,000
Operating Income       $35,000
Interest Expense       $5,000
Pretax Income          $30,000
Taxes                  $7,500
Net Income             $22,500`,
    correct: "INCOME STATEMENT",
    options: ["BALANCE SHEET","INCOME STATEMENT"]
  },
  {
    statement: `XYZ Company Financial Statement
Revenue                $180,000
Cost of Sales          $110,000
Gross Margin           $70,000
Selling Expenses       $25,000
Administrative Exp.    $15,000
Operating Profit       $30,000
Net Profit             $20,000`,
    correct: "INCOME STATEMENT",
    options: ["BALANCE SHEET","INCOME STATEMENT"]
  }
];

// Ratio catalog for Step 2 highlighting
const ratioCategories = {
  "Liquidity Ratios": {
    "Current Ratio": {
      formula: "Current Assets ÷ Current Liabilities",
      highlights: ["Current Assets","Current Liabilities"],
      balanceSheet: true
    },
    "Quick Ratio": {
      formula: "(Cash & Short-term Investments + Accounts Receivable) ÷ Current Liabilities",
      highlights: ["Cash & Short-term Investments","Accounts Receivable","Current Liabilities"],
      balanceSheet: true
    },
    "Cash Ratio": {
      formula: "Cash ÷ Current Liabilities",
      highlights: ["Cash","Current Liabilities"],
      balanceSheet: true
    }
  },
  "Interest Coverage Ratios": {
    "EBIT/Interest Coverage": {
      formula: "EBIT ÷ Interest Expense",
      highlights: ["EBIT","Interest Expense"],
      balanceSheet: false
    },
    "EBITDA/Interest Coverage": {
      formula: "EBITDA ÷ Interest Expense",
      highlights: ["EBITDA","Interest Expense"],
      balanceSheet: false
    }
  },
  "Leverage Ratios": {
    "Debt-Equity Ratio (book)": {
      formula: "Total Debt ÷ Book Value of Equity",
      highlights: ["Total Debt","Book Value of Equity"],
      balanceSheet: true
    },
    "Debt-to-Capital Ratio": {
      formula: "Total Debt ÷ (Total Debt + Book Value of Equity)",
      highlights: ["Total Debt","Book Value of Equity"],
      balanceSheet: true
    },
    "Equity Multiplier (book)": {
      formula: "Total Assets ÷ Book Value of Equity",
      highlights: ["Total Assets","Book Value of Equity"],
      balanceSheet: true
    }
  },
  "Profitability Ratios": {
    "Gross Margin": {
      formula: "Gross Profit ÷ Net Sales",
      highlights: ["Gross Profit","Net Sales"],
      balanceSheet: false
    },
    "Operating Margin": {
      formula: "Operating Income ÷ Net Sales",
      highlights: ["Operating Income","Net Sales"],
      balanceSheet: false
    },
    "Net Profit Margin": {
      formula: "Net Income ÷ Net Sales",
      highlights: ["Net Income","Net Sales"],
      balanceSheet: false
    }
  },
  "Operating Returns": {
    "Asset Turnover": {
      formula: "Sales ÷ Total Assets",
      highlights: ["Sales","Total Assets"],
      balanceSheet: false
    },
    "Return on Equity (ROE)": {
      formula: "Net Income ÷ Book Value of Equity",
      highlights: ["Net Income","Book Value of Equity"],
      balanceSheet: false
    },
    "Return on Assets (ROA)": {
      formula: "(Net Income + Interest Expense) ÷ Total Assets",
      highlights: ["Net Income","Interest Expense","Total Assets"],
      balanceSheet: false
    }
  },
  "Working Capital Ratios": {
    "Accounts Receivable Days": {
      formula: "Accounts Receivable ÷ Average Daily Sales",
      highlights: ["Accounts Receivable","Average Daily Sales"],
      balanceSheet: false
    },
    "Accounts Payable Days": {
      formula: "Accounts Payable ÷ Average Daily Cost of Sales",
      highlights: ["Accounts Payable","Average Daily Cost of Sales"],
      balanceSheet: false
    },
    "Inventory Days": {
      formula: "Inventory ÷ Average Daily Cost of Sales",
      highlights: ["Inventory","Average Daily Cost of Sales"],
      balanceSheet: false
    }
  }
};

// Quiz question templates & pool
const quizPool = [
  // Balance
  { name:"Current Ratio",  template:"DIV", type:"balance",
    slots:{ A:{allowed:["Current Assets"]}, B:{allowed:["Current Liabilities"]} } },
  { name:"Cash Ratio",     template:"DIV", type:"balance",
    slots:{ A:{allowed:["Cash"]}, B:{allowed:["Current Liabilities"]} } },
  { name:"Debt-Equity Ratio (book)", template:"DIV", type:"balance",
    slots:{ A:{allowed:["Total Debt"]}, B:{allowed:["Book Value of Equity"]} } },
  { name:"Equity Multiplier (book)", template:"DIV", type:"balance",
    slots:{ A:{allowed:["Total Assets"]}, B:{allowed:["Book Value of Equity"]} } },
  { name:"Quick Ratio",    template:"ADD_DIV", type:"balance",
    slots:{ A:{allowed:["Cash & Short-term Investments"]},
            B:{allowed:["Accounts Receivable"]},
            C:{allowed:["Current Liabilities"]} } },
  // Income
  { name:"Gross Margin",   template:"DIV", type:"income",
    slots:{ A:{allowed:["Gross Profit"]}, B:{allowed:["Net Sales","Sales"]} } },
  { name:"Operating Margin", template:"DIV", type:"income",
    slots:{ A:{allowed:["Operating Income"]}, B:{allowed:["Net Sales","Sales"]} } },
  { name:"Net Profit Margin", template:"DIV", type:"income",
    slots:{ A:{allowed:["Net Income"]}, B:{allowed:["Net Sales","Sales"]} } },
  { name:"EBIT/Interest Coverage", template:"DIV", type:"income",
    slots:{ A:{allowed:["EBIT"]}, B:{allowed:["Interest Expense"]} } },
  { name:"EBITDA/Interest Coverage", template:"DIV", type:"income",
    slots:{ A:{allowed:["EBITDA"]}, B:{allowed:["Interest Expense"]} } },
  { name:"Asset Turnover", template:"DIV", type:"income",
    slots:{ A:{allowed:["Sales","Net Sales"]}, B:{allowed:["Total Assets"]} } },
  { name:"Return on Assets (ROA)", template:"ADD_DIV", type:"income",
    slots:{ A:{allowed:["Net Income"]}, B:{allowed:["Interest Expense"]}, C:{allowed:["Total Assets"]} } }
];

let quizQuestions = [];

// ---------- Audio (tiny feedback) ----------
function playTone(freq){
  try{
    const Ctx = window.AudioContext || window.webkitAudioContext;
    if(!Ctx) return;
    const ctx = new Ctx();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.connect(g); g.connect(ctx.destination);
    o.type = 'sine'; o.frequency.setValueAtTime(freq, ctx.currentTime);
    g.gain.setValueAtTime(0.25, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.25);
    o.start(); o.stop(ctx.currentTime + 0.25);
  }catch(e){}
}
function ping(type){ if(type==='correct') playTone(800); else if(type==='incorrect') playTone(240); else playTone(600); }

// ---------- Step 1 ----------
function loadStep1Question(){
  console.log('Loading step 1 question...');
  if(step1QuestionIndex >= recognitionQuestions.length){ showStep1Complete(); return; }
  const q = recognitionQuestions[step1QuestionIndex];
  const container = document.getElementById('questionContent');
  if (!container) {
    console.error('Question content container not found!');
    return;
  }
  container.innerHTML = `
    <div class="financial-statement">
      <div class="statement-title">Financial Statement</div>
      <pre>${q.statement}</pre>
    </div>
    <p style="font-size:1.05em;font-weight:bold;margin:12px 0;"><strong>What type of financial statement is this?</strong></p>
    <div class="choice-buttons">
      ${q.options.map(opt => `<button class="btn" onclick="answerRecognition('${opt}')">${opt}</button>`).join('')}
    </div>
    <div id="feedback" style="margin-top:8px;"></div>
  `;
  const currentQuestionElement = document.getElementById('currentQuestion');
  if (currentQuestionElement) {
    currentQuestionElement.textContent = step1QuestionIndex + 1;
  }
  console.log('Step 1 question loaded successfully');
}

function answerRecognition(answer){
  const q = recognitionQuestions[step1QuestionIndex];
  const feedbackDiv = document.getElementById('feedback');
  const buttons = document.querySelectorAll('.choice-buttons .btn');
  buttons.forEach(b => b.disabled = true);
  buttons.forEach(btn => {
    if(btn.textContent === answer){
      if(answer === q.correct){
        btn.classList.add('correct'); step1Score++; ping('correct');
        feedbackDiv.innerHTML = `<div class="feedback-message correct">Excellent! This is a ${q.correct}.</div>`;
      }else{
        btn.classList.add('incorrect'); ping('incorrect');
        feedbackDiv.innerHTML = `<div class="feedback-message incorrect">Not quite right. This is a ${q.correct}.</div>`;
      }
    }
  });
  setTimeout(()=>{ step1QuestionIndex++; loadStep1Question(); }, 1000);
}

function showStep1Complete(){
  const container = document.getElementById('questionContent');
  container.innerHTML = `
    <div style="text-align:center;padding:18px;">
      <h2 style="font-size:1.9em;color:#8b7355;margin-bottom:14px;font-weight:bold;">Great Job!</h2>
      <div class="feedback-message correct" style="display:inline-block;">Recognition Score: ${step1Score} / 3</div>
      <button class="next-btn" onclick="goToStep(2)">Continue to Ratio Learning</button>
    </div>
  `;
}

// ---------- Step 2 (learn) ----------
function displayStatement(type){
  currentStatementType = type;
  const container = document.getElementById('currentStatement');
  const st = type==='balance' ? sampleBalanceSheet : sampleIncomeStatement;
  let html = `<div class="statement-title">${st.title}</div>`;

  if(type==='balance'){
    const sections = {
      "CURRENT ASSETS":["Cash","Cash & Short-term Investments","Accounts Receivable","Inventory","Current Assets"],
      "NON-CURRENT ASSETS":["PP&E","Total Assets"],
      "CURRENT LIABILITIES":["Accounts Payable","Short-term Debt","Current Liabilities"],
      "NON-CURRENT LIABILITIES":["Long-term Debt","Total Debt","Total Liabilities"],
      "EQUITY":["Book Value of Equity","Stockholders' Equity"]
    };
    Object.entries(sections).forEach(([sec,items])=>{
      html += `<div class="section-divider">${sec}</div>`;
      items.forEach(k => { if(st.data[k]!==undefined){
        html += `<div class="statement-line" data-item="${k}"><span class="item-name">${k}</span><span class="item-value">${st.data[k].toLocaleString()}</span></div>`;
      }});
    });
  }else{
    const sections = {
      "REVENUE":["Net Sales","Sales"],
      "COSTS & EXPENSES":["Cost of Goods Sold","Gross Profit","Operating Expenses","Operating Income"],
      "EARNINGS METRICS":["EBIT","Depreciation","EBITDA"],
      "FINAL RESULTS":["Interest Expense","Pretax Income","Taxes","Net Income","Earnings per Share"],
      "DAILY AVERAGES":["Average Daily Sales","Average Daily Cost of Sales"]
    };
    Object.entries(sections).forEach(([sec,items])=>{
      html += `<div class="section-divider">${sec}</div>`;
      items.forEach(k => { if(st.data[k]!==undefined){
        const v = st.data[k];
        const disp = typeof v === 'number' ? (k==="Earnings per Share" ? v.toFixed(2) : v.toLocaleString()) : v;
        html += `<div class="statement-line" data-item="${k}"><span class="item-name">${k}</span><span class="item-value">${disp}</span></div>`;
      }});
    });
  }
  container.innerHTML = html;

  const switchBtn = document.getElementById('switchBtn');
  switchBtn.textContent = `Switch to ${currentStatementType==='balance'?'Income Statement':'Balance Sheet'}`;
  switchBtn.onclick = () => { displayStatement(currentStatementType==='balance'?'income':'balance'); loadRatioButtons(); clearHighlights(); };
}

function loadRatioButtons(){
  const container = document.getElementById('ratioCategories');
  container.innerHTML = '';
  Object.entries(ratioCategories).forEach(([cat,items])=>{
    let buttons = '';
    Object.entries(items).forEach(([rName,r])=>{
      const applicable = (currentStatementType==='balance' && r.balanceSheet) || (currentStatementType==='income' && !r.balanceSheet);
      if(applicable){
        buttons += `<button class="ratio-button" onclick="selectRatio(this,'${rName}','${cat}')"><strong>${rName}</strong><br><small style="opacity:.85;">${r.formula}</small></button>`;
      }
    });
    if(buttons){
      container.innerHTML += `<div class="ratio-category">
        <div class="category-header">${cat}</div>
        <div class="category-ratios">${buttons}</div>
      </div>`;
    }
  });
}

function clearHighlights(){ document.querySelectorAll('.highlight').forEach(el=>el.classList.remove('highlight')); }
function selectRatio(btn, ratioName, cat){
  clearHighlights();
  document.querySelectorAll('.ratio-button.selected').forEach(b=>b.classList.remove('selected'));
  btn.classList.add('selected');
  selectedRatio = ratioName; ratioInteractions++;

  const r = ratioCategories[cat][ratioName];
  let first = null;
  r.highlights.forEach((item, idx)=>{
    const els = document.querySelectorAll(`[data-item="${item}"]`);
    els.forEach(el=>{
      el.classList.add('highlight');
      if(idx===0 && !first) first = el;
    });
  });
  if(first){ setTimeout(()=>first.scrollIntoView({behavior:'smooth', block:'center'}),80); }
  if(ratioInteractions>=3){ document.getElementById('startQuizBtn').style.display='block'; }
}

// ---------- Step 3 (quiz) ----------
function buildStatementsHTML(){
  // Always show BOTH statements
  const b = sampleBalanceSheet, i = sampleIncomeStatement;
  function buildOne(st, type){
    let html = `<div class="statement-card"><div class="statement-title">${st.title}</div>`;
    if(type==='balance'){
      const sections = {
        "CURRENT ASSETS":["Cash","Cash & Short-term Investments","Accounts Receivable","Inventory","Current Assets"],
        "NON-CURRENT ASSETS":["PP&E","Total Assets"],
        "CURRENT LIABILITIES":["Accounts Payable","Short-term Debt","Current Liabilities"],
        "NON-CURRENT LIABILITIES":["Long-term Debt","Total Debt","Total Liabilities"],
        "EQUITY":["Book Value of Equity","Stockholders' Equity"]
      };
      Object.entries(sections).forEach(([sec,items])=>{
        html += `<div class="section-divider">${sec}</div>`;
        items.forEach(k=>{ if(st.data[k]!==undefined){
          html += `<div class="statement-line clickable-quiz" data-item="${k}"><span class="item-name">${k}</span><span class="item-value">${st.data[k].toLocaleString()}</span></div>`;
        }});
      });
    }else{
      const sections = {
        "REVENUE":["Net Sales","Sales"],
        "COSTS & EXPENSES":["Cost of Goods Sold","Gross Profit","Operating Expenses","Operating Income"],
        "EARNINGS METRICS":["EBIT","Depreciation","EBITDA"],
        "FINAL RESULTS":["Interest Expense","Pretax Income","Taxes","Net Income","Earnings per Share"],
        "DAILY AVERAGES":["Average Daily Sales","Average Daily Cost of Sales"]
      };
      Object.entries(sections).forEach(([sec,items])=>{
        html += `<div class="section-divider">${sec}</div>`;
        items.forEach(k=>{ if(st.data[k]!==undefined){
          const v = st.data[k];
          const disp = typeof v === 'number' ? (k==="Earnings per Share" ? v.toFixed(2) : v.toLocaleString()) : v;
          html += `<div class="statement-line clickable-quiz" data-item="${k}"><span class="item-name">${k}</span><span class="item-value">${disp}</span></div>`;
        }});
      });
    }
    html += `</div>`;
    return html;
  }
  return buildOne(b,'balance') + buildOne(i,'income');
}

function randomizeQuiz(){
  const bal = quizPool.filter(q=>q.type==='balance');
  const inc = quizPool.filter(q=>q.type==='income');
  function pick3(arr){ return arr.slice().sort(()=>0.5-Math.random()).slice(0,3); }
  quizQuestions = [...pick3(bal), ...pick3(inc)].sort(()=>0.5-Math.random());
  document.getElementById('totalQuestions').textContent = quizQuestions.length;
}

function templateShort(q){
  if(q.template==='DIV') return 'A ÷ B';
  if(q.template==='ADD_DIV') return '(A + B) ÷ C';
  if(q.template==='ONE_MINUS_DIV') return '(1 − A) ÷ B';
  return '';
}

function renderRatioReference(){
  const ref = document.getElementById('ratioRef');
  ref.innerHTML = '<h4>Current Question</h4>';
  if (currentQuestion) {
    const div = document.createElement('div');
    div.className = 'item active';
    div.innerHTML = `<span>${currentQuestion.name}</span> <span class="tpl">${templateShort(currentQuestion)}</span>`;
    ref.appendChild(div);
  }
}

function renderSlotsForQuestion(q){
  const row = document.getElementById('slotsRow');
  row.innerHTML = '';
  slotAssignments = {}; activeSlotKey = null;

  function slot(key,label){
    const span = document.createElement('span');
    span.className = 'slot-pill empty';
    span.dataset.slot = key;
    span.title = label || key;
    span.innerHTML = `<em>Slot ${label || key}</em>`;
    row.appendChild(span);
  }
  function addOp(ch){ const s=document.createElement('span'); s.className='op'; s.textContent=ch; row.appendChild(s); }
  function addText(t){ const s=document.createElement('span'); s.style.fontWeight='bold'; s.textContent=t; row.appendChild(s); }

  // Auto layout based on template:
  if(q.template==='DIV'){
    slot('A','A'); addOp('÷'); slot('B','B');
  }else if(q.template==='ADD_DIV'){
    addText('('); slot('A','A'); addOp('+'); slot('B','B'); addText(')'); addOp('÷'); slot('C','C');
  }else if(q.template==='ONE_MINUS_DIV'){
    addText('('); addText('1'); addOp('−'); slot('A','A'); addText(')'); addOp('÷'); slot('B','B');
  }
}

function loadQuizQuestion(){
  if(currentQuestionIndex >= quizQuestions.length){ showFinal(); return; }
  currentQuestion = quizQuestions[currentQuestionIndex];
  document.getElementById('quizQuestionText').textContent = `Build the formula for: ${currentQuestion.name}`;
  document.getElementById('dualStatements').innerHTML = buildStatementsHTML();
  renderSlotsForQuestion(currentQuestion);
  renderRatioReference();
  
  // Wait a moment for DOM to update, then setup handlers
  setTimeout(() => {
    setupStatementClickHandlers();
    updateSubmitButton();
  }, 100);
}

function setupStatementClickHandlers(){
  document.querySelectorAll('.clickable-quiz').forEach(line => {
    line.onclick = () => {
      const itemName = line.dataset.item;
      
      // Find the next empty slot
      const allSlots = Object.keys(currentQuestion.slots);
      let nextSlot = null;
      
      for (let slotKey of allSlots) {
        if (!slotAssignments[slotKey]) {
          nextSlot = slotKey;
          break;
        }
      }
      
      if (!nextSlot) {
        alert('All slots are filled! Please remove an item first or submit your answer.');
        return;
      }
      
      // Fill the slot with the selected item
      slotAssignments[nextSlot] = itemName;
      const slot = document.querySelector(`[data-slot="${nextSlot}"]`);
      slot.className = 'slot-pill';
      slot.innerHTML = `${itemName} <button class="slot-remove" onclick="clearSlot('${nextSlot}')">×</button>`;
      updateSubmitButton();
    };
  });
}

function clearSlot(key){
  delete slotAssignments[key];
  const slot = document.querySelector(`[data-slot="${key}"]`);
  slot.className = 'slot-pill empty';
  slot.innerHTML = `<em>Slot ${key}</em>`;
  updateSubmitButton();
}

function updateSubmitButton(){
  const submitBtn = document.getElementById('submitQuizAnswer');
  const allSlots = Object.keys(currentQuestion.slots);
  const filledSlots = Object.keys(slotAssignments);
  submitBtn.disabled = filledSlots.length !== allSlots.length;
}

function submitQuizAnswer(){
  const allSlots = Object.keys(currentQuestion.slots);
  const filledSlots = Object.keys(slotAssignments);
  
  if(filledSlots.length !== allSlots.length) {
    alert('Please fill all slots before submitting!');
    return;
  }
  
  // Check if all assignments are correct
  let correct = true;
  let incorrectSlots = [];
  
  allSlots.forEach(key => {
    const assigned = slotAssignments[key];
    const allowed = currentQuestion.slots[key].allowed;
    if(!allowed.includes(assigned)) {
      correct = false;
      incorrectSlots.push({slot: key, assigned: assigned, correct: allowed[0]});
    }
  });
  
  if(correct){
    quizScore++; ping('correct');
    
    // Show success modal
    const successModal = document.createElement('div');
    successModal.innerHTML = `
      <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                  background: linear-gradient(135deg, #d4edda, #c3e6cb); 
                  border: 3px solid #28a745; border-radius: 15px; padding: 30px; 
                  box-shadow: 0 20px 40px rgba(0,0,0,0.3); z-index: 1000; text-align: center;
                  color: #155724; font-family: 'Comic Sans MS', fantasy;">
          <h3 style="margin-bottom: 15px; font-size: 1.5em;">🎉 Excellent!</h3>
          <p style="font-size: 1.2em; margin-bottom: 15px;">
              <strong>${currentQuestion.name}</strong> formula is correct!
          </p>
          <p>Great job building the ratio formula!</p>
          <button onclick="this.parentElement.parentElement.remove()" 
                  style="margin-top: 15px; padding: 10px 20px; background: #28a745; 
                         color: white; border: none; border-radius: 8px; cursor: pointer; 
                         font-family: inherit;">Continue</button>
      </div>
      <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                  background: rgba(0,0,0,0.5); z-index: 999;"></div>
    `;
    document.body.appendChild(successModal);
  }else{
    ping('incorrect');
    
    // Build student's answer formula
    let studentFormula = '';
    allSlots.forEach(key => {
      const assigned = slotAssignments[key];
      studentFormula += `${assigned}`;
      if (key !== allSlots[allSlots.length - 1]) {
        if (currentQuestion.template === 'DIV' && key === 'A') studentFormula += ' ÷ ';
        else if (currentQuestion.template === 'ADD_DIV') {
          if (key === 'A') studentFormula += ' + ';
          else if (key === 'B') studentFormula += ' ) ÷ ';
        }
      }
    });
    
    // Build correct answer formula
    let correctFormula = '';
    allSlots.forEach(key => {
      const correctItem = currentQuestion.slots[key].allowed[0];
      correctFormula += `${correctItem}`;
      if (key !== allSlots[allSlots.length - 1]) {
        if (currentQuestion.template === 'DIV' && key === 'A') correctFormula += ' ÷ ';
        else if (currentQuestion.template === 'ADD_DIV') {
          if (key === 'A') correctFormula += ' + ';
          else if (key === 'B') correctFormula += ' ) ÷ ';
        }
      }
    });
    
    // Show detailed error modal
    const errorModal = document.createElement('div');
    errorModal.innerHTML = `
      <div style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
                  background: linear-gradient(135deg, #f8d7da, #f1b0b7); 
                  border: 3px solid #dc3545; border-radius: 15px; padding: 30px; 
                  box-shadow: 0 20px 40px rgba(0,0,0,0.3); z-index: 1000; text-align: center;
                  color: #721c24; font-family: 'Comic Sans MS', fantasy; max-width: 400px;">
          <h3 style="margin-bottom: 15px; font-size: 1.5em;">❌ Not Quite Right!</h3>
          <p style="font-size: 1.1em; margin-bottom: 10px;">
              <strong>${currentQuestion.name}</strong> formula
          </p>
          <div style="background: rgba(255,255,255,0.7); padding: 15px; border-radius: 8px; margin: 15px 0;">
              <p style="font-weight: bold; margin-bottom: 8px;">Correct Formula:</p>
              <p style="font-size: 1.1em; color: #155724; font-family: monospace;">
                  ${correctFormula}
              </p>
          </div>
          <p style="font-size: 0.9em; margin-bottom: 15px;">
              <strong>Your answer:</strong><br>
              <span style="font-family: monospace; color: #dc3545;">${studentFormula}</span>
          </p>
          <button onclick="this.parentElement.parentElement.remove()" 
                  style="margin-top: 10px; padding: 10px 20px; background: #dc3545; 
                         color: white; border: none; border-radius: 8px; cursor: pointer; 
                         font-family: inherit;">Continue</button>
      </div>
      <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
                  background: rgba(0,0,0,0.5); z-index: 999;" onclick="this.nextElementSibling.firstElementChild.querySelector('button').click();"></div>
    `;
    document.body.appendChild(errorModal);
  }
  
  // Wait for modal to be dismissed before proceeding
  setTimeout(() => {
    currentQuestionIndex++;
    if (currentQuestionIndex >= quizQuestions.length) {
      showFinal();
    } else {
      loadQuizQuestion();
    }
  }, 100); // Much faster transition after clicking OK
}

function showModal(title, message, type){
  const modal = document.createElement('div');
  modal.className = `modal ${type}`;
  modal.innerHTML = `
    <div class="title">${title}</div>
    <div>${message}</div>
    <button class="btn" onclick="this.parentElement.remove()">OK</button>
  `;
  document.body.appendChild(modal);
}

function showFinal(){
  const finalScore = Math.round(((step1Score + quizScore) / (recognitionQuestions.length + quizQuestions.length)) * 100);
  
  // Go to step 4 (final step) first
  goToStep(4);
  
  // Then replace the content in the final step
  const finalContainer = document.getElementById('final');
  finalContainer.innerHTML = `
    <div style="text-align:center;padding:40px;max-width:800px;margin:0 auto;">
      <h2 style="font-size:2.5em;color:#8b7355;margin-bottom:25px;font-weight:bold;">🎉 Congratulations!</h2>
      
      <div style="background:linear-gradient(135deg,#4CAF50,#45a049);color:white;padding:30px;border-radius:20px;margin:25px 0;font-size:1.3em;box-shadow:0 10px 30px rgba(76,175,80,0.3);">
        <h3 style="margin-bottom:15px;">Final Score: ${finalScore}%</h3>
        <p style="font-size:1.1em;">
          ${finalScore >= 90 ? 'Outstanding! You have mastered financial statement analysis.' : 
            finalScore >= 80 ? 'Excellent work! You have a strong understanding of financial statements.' :
            finalScore >= 70 ? 'Good job! You have a solid foundation in financial analysis.' :
            'Keep practicing! Review the concepts and try again.'}
        </p>
      </div>
      
      <button class="btn" onclick="restartGame()" style="font-size:1.2em;padding:15px 30px;background:linear-gradient(135deg,#28a745,#20c997);margin-top:30px;">
        🔄 Take Quiz Again
      </button>
    </div>
  `;
}

function displayAllRatios(){
  const container = document.getElementById('allRatiosDisplay');
  let html = '';
  
  // Use the actual category names from ratioCategories
  Object.entries(ratioCategories).forEach(([category, ratios]) => {
    html += `<div style="margin-bottom:15px;">`;
    html += `<div style="font-weight:bold; color:#8b7355; margin-bottom:5px; font-size:1.1em;">${category}</div>`;
    Object.entries(ratios).forEach(([ratioName, ratioData]) => {
      html += `<div style="margin-left:15px; margin-bottom:3px; font-size:0.95em;">`;
      html += `<span style="font-weight:500;">${ratioName}:</span> <span style="font-family:monospace; color:#0d47a1;">${ratioData.formula}</span>`;
      html += `</div>`;
    });
    html += `</div>`;
  });
  
  container.innerHTML = html;
}

function restartGame(){
  // Reset all game state
  currentStep = 1;
  step1Score = 0;
  step1QuestionIndex = 0;
  quizScore = 0;
  currentQuestionIndex = 0;
  selectedRatio = null;
  ratioInteractions = 0;
  slotAssignments = {};
  activeSlotKey = null;
  currentQuestion = null;
  quizQuestions = [];
  
  // Go back to step 1
  goToStep(1);
  loadStep1Question();
}



// ---------- Navigation ----------
function goToStep(step){
  document.querySelectorAll('.step').forEach(s => s.classList.remove('active'));
  document.getElementById(`step${step}`).classList.add('active');
  currentStep = step;
  
  // Update progress bar
  const progress = (step / 4) * 100;
  document.getElementById('progressBar').style.width = progress + '%';
  
  if(step === 2){
    displayStatement('balance');
    loadRatioButtons();
    document.getElementById('startQuizBtn').onclick = () => goToStep(3);
  }else if(step === 3){
    randomizeQuiz();
    loadQuizQuestion();
    document.getElementById('clearAllBtn').onclick = () => {
      slotAssignments = {};
      renderSlotsForQuestion(currentQuestion);
      updateSubmitButton();
    };
    document.getElementById('submitQuizAnswer').onclick = submitQuizAnswer;
  }else if(step === 4){
    document.getElementById('restartBtn').onclick = () => {
      currentStep = 1; step1Score = 0; step1QuestionIndex = 0; quizScore = 0; currentQuestionIndex = 0;
      goToStep(1); loadStep1Question();
    };
    document.getElementById('goHomeBtn').onclick = () => {
      // Close the game and return to the course page
      if (window.opener) {
        window.close();
      } else {
        window.location.href = '/teaching/335/chapter-2';
      }
    };
  }
}

// ---------- Initialize ----------
document.addEventListener('DOMContentLoaded', () => {
  try {
    console.log('Game initializing...');
    loadStep1Question();
    console.log('Game initialized successfully');
  } catch (error) {
    console.error('Error initializing game:', error);
    // Show a fallback message if there's an error
    const container = document.getElementById('questionContent');
    if (container) {
      container.innerHTML = `
        <div style="text-align:center;padding:20px;">
          <h3 style="color:#8b7355;">Game Loading...</h3>
          <p>If the game doesn't load, please refresh the page.</p>
          <button class="btn" onclick="location.reload()">Refresh Page</button>
        </div>
      `;
    }
  }
});
</script>
</body>
</html>
